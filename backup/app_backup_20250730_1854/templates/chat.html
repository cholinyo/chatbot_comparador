{% extends "base.html" %}
{% block title %}Chat RAG Avanzado{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8">
      <h2 class="mb-4">ğŸ’¬ Chat Inteligente con ChromaDB + LlamaIndex</h2>
      
      <!-- Alerta de mejoras -->
      <div class="alert alert-info" role="alert">
        <h6 class="alert-heading">ğŸš€ Sistema Actualizado</h6>
        <p class="mb-0">
          Ahora usando <strong>ChromaDB</strong> + <strong>LlamaIndex</strong> para bÃºsqueda semÃ¡ntica optimizada 
          y detecciÃ³n inteligente de tipos de documento municipal.
        </p>
      </div>

      <!-- Formulario principal -->
      <form method="post" class="mb-4">
        <div class="row">
          <div class="col-md-12 mb-3">
            <label for="pregunta" class="form-label">Tu consulta:</label>
            <textarea 
              class="form-control" 
              id="pregunta" 
              name="pregunta" 
              rows="3" 
              placeholder="Ej: Â¿QuÃ© documentos necesito para solicitar una licencia de obras?"
              required>{{ pregunta }}</textarea>
          </div>
        </div>

        <!-- Filtros avanzados -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="tipo_documento" class="form-label">Filtrar por tipo:</label>
            <select class="form-select" id="tipo_documento" name="tipo_documento">
              <option value="todos">ğŸ“„ Todos los documentos</option>
              {% for tipo in tipos_disponibles %}
              <option value="{{ tipo }}" {% if tipo == tipo_seleccionado %}selected{% endif %}>
                {% if tipo == "ordenanza" %}ğŸ“œ{% elif tipo == "acta" %}ğŸ“{% elif tipo == "resolucion" %}âš–ï¸{% elif tipo == "presupuesto" %}ğŸ’°{% else %}ğŸ“„{% endif %}
                {{ tipo.title() }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3 mb-3">
            <label for="k_fragmentos" class="form-label">Fragmentos a recuperar:</label>
            <input type="number" class="form-control" id="k_fragmentos" name="k_fragmentos" 
                   value="5" min="1" max="20">
          </div>

          <div class="col-md-3 mb-3 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="busqueda_avanzada" name="busqueda_avanzada">
              <label class="form-check-label" for="busqueda_avanzada">
                ğŸ” BÃºsqueda avanzada
              </label>
            </div>
          </div>

          <div class="col-md-2 mb-3 d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i> Consultar
            </button>
          </div>
        </div>
      </form>

      <!-- Mostrar errores -->
      {% if error %}
      <div class="alert alert-danger" role="alert">
        âŒ {{ error }}
      </div>
      {% endif %}

      <!-- Resultados -->
      {% if respuesta %}
      <!-- InformaciÃ³n de la consulta -->
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-light">
          <h6 class="card-title mb-0">
            ğŸ” Consulta: "{{ pregunta }}"
            {% if tipo_seleccionado and tipo_seleccionado != "todos" %}
            <span class="badge bg-secondary">Filtro: {{ tipo_seleccionado }}</span>
            {% endif %}
          </h6>
          {% if tiempo_respuesta %}
          <small class="text-muted">â±ï¸ Tiempo de respuesta: {{ "%.2f"|format(tiempo_respuesta) }}s</small>
          {% endif %}
        </div>
      </div>

      <!-- Fragmentos recuperados -->
      {% if contexto %}
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h6 class="card-title mb-0">
            ğŸ“š Fragmentos Recuperados ({{ contexto|length }})
            <button class="btn btn-sm btn-outline-secondary float-end" type="button" 
                    data-bs-toggle="collapse" data-bs-target="#fragmentosCollapse">
              <i class="fas fa-eye"></i> Ver/Ocultar
            </button>
          </h6>
        </div>
        <div class="collapse" id="fragmentosCollapse">
          <div class="card-body">
            {% for frag in contexto %}
            <div class="border rounded p-3 mb-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <span class="badge bg-info">
                    {% if frag.fuente == "ordenanza" %}ğŸ“œ
                    {% elif frag.fuente == "acta" %}ğŸ“
                    {% elif frag.fuente == "resolucion" %}âš–ï¸
                    {% elif frag.fuente == "presupuesto" %}ğŸ’°
                    {% else %}ğŸ“„{% endif %}
                    {{ frag.fuente|title }}
                  </span>
                  {% if frag.metadata and frag.metadata.get('origen') %}
                  <small class="text-muted">â€¢ {{ frag.metadata.origen }}</small>
                  {% endif %}
                </div>
                <small class="text-muted">
                  Relevancia: â˜…â˜…â˜…â˜…â˜†
                </small>
              </div>
              <div class="text-muted">
                {{ frag.texto }}
              </div>
              {% if frag.metadata %}
              <div class="mt-2">
                {% if frag.metadata.get('article_number') %}
                <small class="badge bg-light text-dark">Art. {{ frag.metadata.article_number }}</small>
                {% endif %}
                {% if frag.metadata.get('point_number') %}
                <small class="badge bg-light text-dark">Punto {{ frag.metadata.point_number }}</small>
                {% endif %}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Respuesta generada -->
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h6 class="card-title mb-0">ğŸ¤– Respuesta del Asistente</h6>
        </div>
        <div class="card-body">
          <div class="response-content">
            {{ respuesta|replace('\n', '<br>')|safe }}
          </div>
          
          <!-- Advertencia sobre limitaciones -->
          <div class="alert alert-warning mt-3 mb-0" role="alert">
            <small>
              âš ï¸ <strong>Importante:</strong> Esta respuesta se basa Ãºnicamente en los documentos 
              indexados en el sistema. Verifica siempre la informaciÃ³n con fuentes oficiales actualizadas.
            </small>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Panel lateral con informaciÃ³n -->
    <div class="col-md-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header">
          <h6 class="card-title mb-0">ğŸ“Š Estado del Sistema</h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li>ğŸ—‚ï¸ Base de datos: <strong>ChromaDB</strong></li>
            <li>ğŸ” Motor: <strong>LlamaIndex</strong></li>
            <li>ğŸ§  Modelo: <strong>Local (Ollama)</strong></li>
            <li>ğŸ“„ Tipos disponibles: <strong>{{ tipos_disponibles|length }}</strong></li>
          </ul>
        </div>
      </div>

      <!-- Tipos de documento disponibles -->
      {% if tipos_disponibles %}
      <div class="card shadow-sm mb-3">
        <div class="card-header">
          <h6 class="card-title mb-0">ğŸ“‹ Tipos de Documento</h6>
        </div>
        <div class="card-body">
          {% for tipo in tipos_disponibles %}
          <span class="badge bg-secondary me-1 mb-1">
            {% if tipo == "ordenanza" %}ğŸ“œ{% elif tipo == "acta" %}ğŸ“{% elif tipo == "resolucion" %}âš–ï¸{% elif tipo == "presupuesto" %}ğŸ’°{% else %}ğŸ“„{% endif %}
            {{ tipo }}
          </span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Consejos de uso -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h6 class="card-title mb-0">ğŸ’¡ Consejos de Uso</h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled small mb-0">
            <li>ğŸ¯ <strong>EspecÃ­fico:</strong> "Â¿QuÃ© tasa tengo que pagar por licencia de obra?"</li>
            <li>ğŸ·ï¸ <strong>Por tipo:</strong> Filtra por ordenanza, acta, resoluciÃ³n, etc.</li>
            <li>ğŸ” <strong>Avanzado:</strong> Usa la bÃºsqueda avanzada para consultas complejas</li>
            <li>ğŸ“Š <strong>Fragmentos:</strong> Aumenta el nÃºmero para mÃ¡s contexto</li>
          </ul>
        </div>
      </div>

      <!-- Enlaces rÃ¡pidos -->
      <div class="card shadow-sm mt-3">
        <div class="card-header">
          <h6 class="card-title mb-0">ğŸ”— Accesos RÃ¡pidos</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="/chat/avanzado" class="btn btn-outline-primary btn-sm">
              ğŸ”¬ Chat Avanzado
            </a>
            <a href="/comparar" class="btn btn-outline-secondary btn-sm">
              âš–ï¸ Comparar Modelos
            </a>
            <a href="/config" class="btn btn-outline-info btn-sm">
              âš™ï¸ ConfiguraciÃ³n RAG
            </a>
            <a href="/vectorstore" class="btn btn-outline-warning btn-sm">
              ğŸ“Š Estado Vectorstore
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.response-content {
  line-height: 1.6;
  white-space: pre-line;
}

.badge {
  font-size: 0.75em;
}

.card {
  border: none;
  border-radius: 0.5rem;
}

.card-header {
  border-radius: 0.5rem 0.5rem 0 0 !important;
}

.form-control:focus,
.form-select:focus {
  border-color: #86b7fe;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.text-muted {
  font-size: 0.9em;
}
</style>

<script>
// Auto-expand textarea
document.getElementById('pregunta').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = this.scrollHeight + 'px';
});

// Tooltip para elementos con tÃ­tulo
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl);
});
</script>
{% endblock %}